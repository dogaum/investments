<?xml version="1.0" encoding="ISO-8859-1" ?>  
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"  
    xmlns:h="http://java.sun.com/jsf/html"  
    xmlns:f="http://java.sun.com/jsf/core"  
    xmlns:ui="http://java.sun.com/jsf/facelets"  
    xmlns:p="http://primefaces.org/ui"
    xmlns:pe="http://primefaces.org/ui/extensions"  
    template="../template/template.xhtml">

    <ui:define name="title">
    	<h:outputText value="#{msg['app.portfolio.title']}"/>
    </ui:define>
	<ui:define name="body">
		<h:form id="form">
            <!-- Page Heading -->
            <div class="row" id="divSubtitle">
                <div class="col-lg-12">
                    <ol class="breadcrumb">
                        <li class="active">
                            <i class="fa fa-fw fa-table"></i> <h:outputText value=" #{msg['app.portfolio.title']}"/>
                        </li>
                    </ol>
                </div>
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-green">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-plus-square-o fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="medium"><h:outputText value=" #{msg['app.portfolio.lbl.add']}" /></div>
                                    <div></div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <span class="pull-left">
							    <p:commandLink id="clAddPortfolio" onclick="PF('addPortfolioDlg').show()">
							        <h:outputText value=" #{msg['app.portfolio.link.add']}" />
							    </p:commandLink>
                            </span>
                            <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>
	    		<ui:repeat id="carteiras" var="portfolio" value="#{carteiraView.carteiras}" varStatus="portfolioStatus">
	                <div class="col-lg-3 col-md-6">
	                    <div class="panel panel-primary">
	                        <div class="panel-heading">
	                            <div class="row">
	                                <div class="col-xs-3">
	                                    <i class="fa fa-list-alt fa-5x"></i>
	                                </div>
	                                <div class="col-xs-9 text-right">
	                                    <div class="huge">#{portfolio.name}</div>
	                                    <div></div>
	                                </div>
	                            </div>
	                        </div>
	                        <div class="panel-footer">
	                            <span class="pull-left">
							        <p:commandLink value="#{msg['app.portfolio.lbl.detail']}" title="#{msg['app.portfolio.link.detail']}" action="#{carteiraView.selectCarteira}" update=":form:portfolioDetail"
							        			  style="float:left;margin-right:10px">
							            <f:setPropertyActionListener value="#{portfolio}" target="#{carteiraView.selectedCarteira}" />
						        	</p:commandLink>
	                            </span>
	                            <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
	                            <div class="clearfix"></div>
	                        </div>
	                    </div>
	                </div>
	    		</ui:repeat>
            </div>
            <div class="row">
                <div class="col-lg-12">
				    <p:outputPanel id="portfolioDetail" deferred="true" rendered="#{not empty carteiraView.selectedCarteira}">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <h3 class="panel-title"><i class="fa fa-long-arrow-right"></i><h:outputText value=" #{msg['app.portfolio.subtitle']} #{carteiraView.selectedCarteira.name}"/></h3>
                            </div>
                            <div class="panel-body">
						        <p>
						        	<b><h:outputText value="#{msg['app.portfolio.created']} " /></b> <h:outputText value="#{carteiraView.selectedCarteira.createDate}"><f:convertDateTime locale="#{msg['locale']}"  /></h:outputText>
						        </p>

							    <p:commandLink id="clNewNegotiation" onclick="PF('addNegotiationDlg').show()" actionListener="#{carteiraView.prepareNegotiation}"
							    				update=":form:panelNewNegotiation">
							        <h:outputText value="#{msg['app.portfolio.negotiation.add']}" />
							    </p:commandLink>

								<p:dataTable id="itemTable" var="item" value="#{carteiraView.carteiraItens}" emptyMessage="#{msg['pf.datatable.noresults']}">
									<p:column style="width:38px">
							            <p:rowToggler />
							        </p:column>

								    <p:column headerText="#{msg['app.portfolio.symbol']}">
								        <h:outputText value="#{item.stock}" />
								    </p:column>

								    <p:column headerText="#{msg['app.portfolio.qty']}">
								        <h:outputText value="#{item.quantity}" />
								    </p:column>
								 
								    <p:column headerText="#{msg['app.portfolio.avgValue']}">
								        <h:outputText value="#{item.avgValue}">
								        	<f:convertNumber type="currency" currencySymbol="#{msg['currencySymbol']}" maxFractionDigits="2" locale="#{msg['locale']}"/>
								        </h:outputText>
								    </p:column>
								 
								    <p:column headerText="#{msg['app.portfolio.total']}">
								        <h:outputText value="#{item.totalValue}">
								        	<f:convertNumber type="currency" currencySymbol="#{msg['currencySymbol']}" maxFractionDigits="2" locale="#{msg['locale']}"/>
								        </h:outputText>
								    </p:column>

							        <p:rowExpansion>
										<p:dataTable widgetVar="negItemTable" var="negItem" value="#{item.negotiations}" style="margin-left:27px" rowKey="#{negItem.id}"
													 editable="true">

											<p:ajax event="rowEdit" listener="#{carteiraView.editNegotiation}" update=":form:portfolioDetail" />
 
 										    <p:column headerText="#{msg['app.portfolio.date']}" sortBy="#{negItem.dtNegociation}">
										        <h:outputText value="#{negItem.dtNegociation}">
										        	<f:convertDateTime locale="#{msg['locale']}"  />
										        </h:outputText>
										    </p:column>

										    <p:column headerText="#{msg['app.portfolio.symbol']}" sortBy="#{negItem.stock}">
										        <h:outputText value="#{negItem.stock}" />
										    </p:column>

										    <p:column headerText="#{msg['app.portfolio.type']}" sortBy="#{negItem.negociationType}">
									           <p:cellEditor>
									               <f:facet name="output"><h:outputText value="#{negItem.negociationType}" /></f:facet>
									               <f:facet name="input">
												       <p:selectOneMenu id="negType" value="#{negItem.negociationType}" style="width:100%">
								            		   		<f:selectItems value="#{carteiraView.negotiationTypes}" />
												       </p:selectOneMenu>
									               </f:facet>
									            </p:cellEditor>
										    </p:column>
										 
										    <p:column headerText="#{msg['app.portfolio.qty']}" sortBy="#{negItem.quantity}">
									           <p:cellEditor>
									               <f:facet name="output"><h:outputText value="#{negItem.quantity}" /></f:facet>
									               <f:facet name="input"><p:spinner value="#{negItem.quantity}" min="0" /></f:facet>
									            </p:cellEditor>
										    </p:column>

										    <p:column headerText="#{msg['app.portfolio.value']}" sortBy="#{negItem.value}">
									           <p:cellEditor>
									               <f:facet name="output">
												        <h:outputText value="#{negItem.value}">
												        	<f:convertNumber type="currency" currencySymbol="#{msg['currencySymbol']}" maxFractionDigits="2" locale="#{msg['locale']}"/>
												        </h:outputText>
									               </f:facet>
									               <f:facet name="input"><pe:inputNumber value="#{negItem.value}"  symbol="#{msg['currencySymbol']} "/></f:facet>
									            </p:cellEditor>
										    </p:column>

										    <p:column headerText="#{msg['app.portfolio.costs']}" sortBy="#{negItem.costs}">
									           <p:cellEditor>
									               <f:facet name="output">
												        <h:outputText value="#{negItem.costs}">
												        	<f:convertNumber type="currency" currencySymbol="#{msg['currencySymbol']}" maxFractionDigits="2" locale="#{msg['locale']}"/>
												        </h:outputText>
									               </f:facet>
									               <f:facet name="input"><pe:inputNumber value="#{negItem.costs}"  symbol="#{msg['currencySymbol']} "/></f:facet>
									            </p:cellEditor>
										    </p:column>

										    <p:column style="width:38px">
										        <p:rowEditor />
										    </p:column>
										    <p:column style="width:48px">
										        <p:commandButton icon="ui-icon-close" action="#{carteiraView.deleteNegotiation}" update=":form:portfolioDetail" id="cbDeleteNegotiation">
										        	<p:confirm header="#{msg['app.portfolio.delete.dlg.confirm']}" message="#{msg['app.portfolio.delete.dlg.msg']}" icon="ui-icon-alert" />
										        	<f:setPropertyActionListener value="#{negItem}" target="#{carteiraView.negotiation}" for="cbDeleteNegotiation"/>
										        </p:commandButton>
										    </p:column>
										</p:dataTable>
        							</p:rowExpansion>
								</p:dataTable>
                            </div>
                        </div>
				    </p:outputPanel>

				    <p:confirmDialog global="true" showEffect="fade" hideEffect="explode">
				        <p:commandButton value="#{msg['app.label.yes']}" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
				        <p:commandButton value="#{msg['app.label.no']}" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
				    </p:confirmDialog>

			        <p:dialog widgetVar="addPortfolioDlg" modal="true" position="center" header="#{msg['app.portfolio.newPortfolio']}" width="530" showEffect="fade" hideEffect="fade" closeOnEscape="true">
						<p:panel id="panelNewCarteira">
			                <h:panelGrid columns="2">
			                    <h:outputLabel for="newName" value="#{msg['app.portfolio.name']}: " />
			                    <h:inputText id="newName" value="#{carteiraView.newName}" label="newName"/>
			                </h:panelGrid>
			
			                <p:separator />
			                <p:toolbar>
			                	<f:facet name="left">
			                		<p:commandButton value="#{msg['btn.cancel']}" onclick="PF('addPortfolioDlg').hide()" type="button"/>
			                	</f:facet>
			                	<f:facet name="right">
			                		<p:commandButton value="#{msg['btn.add']}" onclick="PF('addPortfolioDlg').hide()" actionListener="#{carteiraView.create}" update=":form"/>
			                	</f:facet>
			                </p:toolbar>
						</p:panel>
			        </p:dialog>
		
			        <p:dialog widgetVar="addNegotiationDlg" modal="true" position="center" header="#{msg['app.portfolio.add.dlg.header']}" width="530" showEffect="fade" hideEffect="fade" closeOnEscape="true">
						<p:panel id="panelNewNegotiation">
			                <h:panelGrid columns="2" cellspacing="5" rendered="#{not empty carteiraView.negotiation}">
			                    <p:outputLabel for="negType" value="#{msg['app.portfolio.type']}: " />
						        <p:selectOneMenu id="negType" value="#{carteiraView.negotiation.negociationType}" >
		            				<f:selectItems value="#{carteiraView.negotiationTypes}" />
						        </p:selectOneMenu>
		
						        <p:outputLabel value="#{msg['app.portfolio.symbol']}:" for="negSymbol" />
						        <p:autoComplete id="negSymbol" minQueryLength="3" value="#{carteiraView.negotiation.stock}"
						        			 completeMethod="#{chartView.completeStock}" effect="fade" />
		
		 						<p:outputLabel for="negDate" value="#{msg['app.portfolio.date']}:" />
		        				<p:calendar id="negDate" value="#{carteiraView.negotiation.dtNegociation}" pattern="dd/MM/yyyy" mask="true" />
		
								<p:outputLabel value="#{msg['app.portfolio.qty']}:" for="negQuantity" />
								<p:spinner id="negQuantity" value="#{carteiraView.negotiation.quantity}" min="0" />
		
								<p:outputLabel value="#{msg['app.portfolio.unitValue']}:" for="negUnitValue" />
								<pe:inputNumber id="negUnitValue" value="#{carteiraView.negotiation.value}"  symbol="#{msg['currencySymbol']} " />
		
								<p:outputLabel value="#{msg['app.portfolio.costs']}:" for="negCosts" />
								<pe:inputNumber id="negCosts" value="#{carteiraView.negotiation.costs}"  symbol="#{msg['currencySymbol']} " />
			                </h:panelGrid>
			
			                <p:separator />
			                <p:toolbar>
			                	<f:facet name="left">
			                		<p:commandButton value="#{msg['btn.cancel']}" onclick="PF('addNegotiationDlg').hide()" type="button"/>
			                	</f:facet>
			                	<f:facet name="right">
			                		<p:commandButton value="#{msg['btn.add']}" onclick="PF('addNegotiationDlg').hide()" actionListener="#{carteiraView.addNegotiation}" update=":form:portfolioDetail"/>
			                	</f:facet>
			                </p:toolbar>
						</p:panel>
			        </p:dialog>
                </div>
            </div>
		</h:form>
    </ui:define>
</ui:composition>